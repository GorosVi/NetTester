Высокоуровневая схема со встречи не потребовала изменений, поэтому особых в ней сомнений не осталось =)
Пара дополнительных моментов:
* Вроде все использованные альтеровские модули имеют обёртку для qsys-а. Тогда есть смысл все три моих макро-модуля сделать совместимыми, и в нём-же и собрать. Фактически получилась архитектура для top-level, которой будет достаточно =)
* Альтеровский MAC поддерживает управление регистрами PHY, посмотрел документацию на KSZ9021, который заявлен в плате DE10 - для работы системы доступ в них не должен понадобиться, но при необходимости можно подключить интерфейс управления к нему и настраивать по общей для системы шине Avalon-MM. (На перерисованном мной варианте интерфейс управления подключен, но пока про него можно забыть)


Теперь помодульно: (все указанные регистры RW)

MAC
===
Используется готовое IP-ядро Altera Triple-sppeed-Ethernet в следующей конфигурации:
* Базовая конфигурация - 8-битная шина данных без включения встроенных FIFO.
* Включена фильтрация по MAC адресу интерфейса устройства, не свои пакеты не принимаются
* Преамбула и CRC пакета обрезаются
* Интерфейс к PHY MDIO выключен



Генератор (Timestamp_Generator)
===============================
Остался неуправляемым счётчиком, с жёстко заданным делителем для тактовой частоты, регистров статуса и управления нет. Результат выдаётся на 32-битный параллельный интерфейс.



Передатчик
==========

Передатчик разбит на 3 подмодуля, интерфейс между ними - avalon-st 8-bit, с сигналом занятости. Выход подключается на вход модуля MAC.

Подмодуль Packet_Generator
--------------------------

Последовательно выдаёт пакет, состоящий из заголовка, заданного в некотором блоке памяти, и заполнителя до конца длины пакета.
Должен останавливать передачу по сигналу busy, но при готовности приёмника выдавать данные каждый такт.
Параметры:
* Заголовок пакета pkt_header (область памяти длиной 28 байт, доступная через Avalon-MM)
* Длина пакета (32-битный регистр, доступный через Avalon-MM)

Подмодуль Sequencer
-------------------

Передаёт пакет, полученный от предыдущего модуля без изменений, но выжидает необходимый промежуток времени между передачей пакетов для создания определённого битрейта. Автоматически прекращает работу после передачи заданного количества пакетов.
Должен останавливать передачу по сигналу busy, но при готовности приёмника выдавать данные каждый такт, кроме пауз в передаче.
Управляется флагами разрешения и остановки передачи.
Параметры:
* Пауза между пакетами (32-битный регистр, доступный через Avalon-MM)
* Число отправляемых пакетов (32-битный регистр, доступный через Avalon-MM)
* Флаги разрешения передачи, остановки передачи (32-битный регистр, доступный через Avalon-MM)

Подмодуль Timestamp_Marker
--------------------------

Отмечает проходящий через модуль пакет значением с Timestamp_Generator в определённом месте (сразу после UDP-заголовка)
Должен при готовности приёмника выдавать данные каждый такт, сигнал занятости пересылается вышестоящему модулю. (Если следовать документации, MAC не должен прерывать передачу данных посередине пакета, нужно ещё раз уточнить)
Не имеет параметров, данные с Timestamp_Generator передаются на вход по параллельному интерфейсу.



Приёмник
========

Приёмник разбит на 4 подмодуля, интерфейс между ними - avalon-st 8-bit. После анализа нужных системе данных все пакеты уничтожаются.
Все модули в цепочке должны быть готовы принимать данные каждый такт и не останавливать приём данных от MAC.

Подмодуль Filter_Tagger
-----------------------

Принимает пакет, проверяет наличие протокола UDP и значения порта назначения. При совпадении обоих требований пакет считается принятым для измерения задержки. Результат проверки передаётся на выход в конце пакета.
Контролирует индикацию ошибки в MAC, статус ошибки тоже передаётся в конце пакета.
На выход передаёт поток данных пакета и два сигнала-результата проверки (на пакет для измерения задержки и наличие ошибки), значения которых достоверны в момент окончания пакета.
Параметры:
* Port-SRC - порт протокола UDP (32-битный регистр, доступный через Avalon-MM)
* IP-SRC - IP адрес хоста (32-битный регистр, доступный через Avalon-MM)

Подмодуль Timestamp_Reader
--------------------------

Принимает пакет, флаги от предыдущего модуля и передаёт их без изменений на выход.
В процессе обработки пакета вычисляет время между его отправкой и текущим временем системы, даже если это левый пакет.
Результат вычисления также передаётся на выход по дополнительному параллельному 32-битному интерфейсу и должен быть валиден на момент окончания пакета.

Подмодуль Tag_Reader
--------------------

Принимает пакет, флаги от предыдущего модуля и результат измерения задержки.
В конце каждого пакета проверяет флаг состояния, результаты, переданные модулем Filter_Tagger на то, что пакет принят без ошибок и предназначен для измерения задержки.
Если пакет проходит все проверки, можно считать результат предыдущего модуля достоверным и передать его следующему модулю.
Результат передаётся созданием транзакции на 32-битной шине Avalon-ST.
Параметры:
* Флаг включения модуля (32-битный регистр, доступный через Avalon-MM)

Подмодуль Result_Collector
--------------------------

Принимает транзакции от предыдущего модуля и складывает их в 32-битный FIFO. Позволяет хосту читать данные с помощью регистра данных и флага запроса следующего регистра. Имеет read-only статусный регистр, показывающий количество данных в FIFO.
По запросу следующего значения модуль сбрасывает соответствующий флаг и обновляет регистр данных.
(По хорошему, он должен складывать данные в область памяти по DMA, но пока так)
Параметры:
* Статусный регистр - количество отсчётов в FIFO (RO 32-битный регистр, доступный через Avalon-MM)
* Флаг чтения данных (32-битный регистр, доступный через Avalon-MM)
* Регистр данных - результатов измерения (32-битный регистр, доступный через Avalon-MM)
